Проверку на уникальность при попытке вставки записи в таблицу надо осуществлять не простой выборкой с прямым сравнением записей:
	
	IF EXISTS (SELECT id FROM users WHERE login = loc_login)
			THEN SET error = 'Пользователь с таким логином уже зарегистрирован.';  - неправильно
			
А надо создавать уникальный ключ на запись таблицы 	
	
	CONSTRAINT uk_users_login UNIQUE KEY (login)

и затем отлавливать ошибку при попытке вставки уже существующей записи : 

	ERROR 1062(2300): Duplicate entry ...

Тем самым мы вместо двух операций : 1)проверка с выборкой и 2)вставка с проверой на уникальность будем делать только одну операцию
: вставка с проверой на уникальност с отловом ошибки на дублирование записи.

Это особенно даст выигрыш при огромных таблицах (таблицы с данными пользователей).